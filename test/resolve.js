import expectThrow from '../helpers/expectThrow';

var Betting = artifacts.require("Betting");

contract('Betting', function(accounts, app) {

  it("A user should be able to propose a bet, which can be retrieved", function() {
    var app;
    var proposer = accounts[0];
    var proposerAmount = web3.toWei(1, "ether");
    var acceptorAmount = web3.toWei(1, "ether");
    var totalAmount = web3.toWei(2, "ether");
    var homeScore = 1;
    var awayScore = 0;
    var fixtureID = 158958;
    var betJSON =
    "\x20\x00\x10\x00\xef\xbf\xbd\xef\xbf\xbd\x03\x00\xc9\x80\x38\x67\x04\x6c\x05\x00\xef\xbf\xbd\x5c\x3d\x67\x04\x6c\x05\x00\x40\x00\x00\x00\x04\x00\x00\x00\x49\xef\xbf\xbd\xef\xbf\xbd\xef\xbf\xbd\x7c\xef\xbf\xbd\x6a\x62\xef\xbf\xbd\xef\xbf\xbd\x4f\xef\xbf\xbd\xef\xbf\xbd\xef\xbf\xbd\xef\xbf\xbd\xc3\xb0\xef\xbf\xbd\x1a\xef\xbf\xbd\x6f\xef\xbf\xbd\xef\xbf\xbd\x06\x65\xef\xbf\xbd\x1b\x13\x12\xef\xbf\xbd\xef\xbf\xbd\x60\x28\x6a\xef\xbf\xbd\x12\xef\xbf\xbd\x55\xef\xbf\xbd\x7f\xef\xbf\xbd\x2e\x0b\x5d\xef\xbf\xbd\x1d\xef\xbf\xbd\xef\xbf\xbd\xef\xbf\xbd\x55\x43\xef\xbf\xbd\xef\xbf\xbd\x4c\x27\xef\xbf\xbd\xef\xbf\xbd\xef\xbf\xbd\x49\x77\x25\x74\x76\x1e\x02\xef\xbf\xbd\x00\x00\x47\x45\x54\x20\x2f\x70\x72\x6f\x78\x79\x2e\x70\x79\x3f\x75\x72\x6c\x3d\x68\x74\x74\x70\x25\x33\x41\x2f\x2f\x61\x70\x69\x2e\x66\x6f\x6f\x74\x62\x61\x6c\x6c\x2d\x64\x61\x74\x61\x2e\x6f\x72\x67\x2f\x76\x31\x2f\x66\x69\x78\x74\x75\x72\x65\x73\x2f\x31\x35\x38\x39\x34\x36\x25\x33\x46\x68\x65\x61\x64\x32\x68\x65\x61\x64\x25\x33\x44\x30\x20\x48\x54\x54\x50\x2f\x31\x2e\x31\x0d\x0a\x48\x6f\x73\x74\x3a\x20\x74\x6c\x73\x70\x72\x6f\x6f\x66\x2e\x62\x61\x73\x74\x69\x65\x6e\x2e\x74\x65\x63\x68\x0d\x0a\x43\x6f\x6e\x6e\x65\x63\x74\x69\x6f\x6e\x3a\x20\x6b\x65\x65\x70\x2d\x61\x6c\x69\x76\x65\x0d\x0a\x0d\x0a\x33\xef\xbf\xbd\x21\xef\xbf\xbd\x65\xef\xbf\xbd\xef\xbf\xbd\x25\xdb\xaf\xef\xbf\xbd\xef\xbf\xbd\x1c\x10\x2a\xef\xbf\xbd\x02\xef\xbf\xbd\x01\x01\x48\x54\x54\x50\x2f\x31\x2e\x31\x20\x32\x30\x30\x20\x4f\x4b\x0d\x0a\x44\x61\x74\x65\x3a\x20\x53\x61\x74\x2c\x20\x31\x32\x20\x4d\x61\x79\x20\x32\x30\x31\x38\x20\x31\x36\x3a\x30\x34\x3a\x31\x30\x20\x47\x4d\x54\x0d\x0a\x53\x65\x72\x76\x65\x72\x3a\x20\x41\x70\x61\x63\x68\x65\x2f\x32\x2e\x34\x2e\x31\x38\x20\x28\x55\x62\x75\x6e\x74\x75\x29\x0d\x0a\x43\x6f\x6e\x6e\x65\x63\x74\x69\x6f\x6e\x3a\x20\x63\x6c\x6f\x73\x65\x0d\x0a\x58\x2d\x41\x70\x70\x6c\x69\x63\x61\x74\x69\x6f\x6e\x2d\x43\x6f\x6e\x74\x65\x78\x74\x3a\x20\x61\x70\x70\x6c\x69\x63\x61\x74\x69\x6f\x6e\x3a\x70\x72\x6f\x64\x75\x63\x74\x69\x6f\x6e\x0d\x0a\x58\x2d\x52\x65\x71\x75\x65\x73\x74\x73\x2d\x41\x76\x61\x69\x6c\x61\x62\x6c\x65\x3a\x20\x34\x38\x0d\x0a\x58\x2d\x52\x65\x71\x75\x65\x73\x74\x43\x6f\x75\x6e\x74\x65\x72\x2d\x52\x65\x73\x65\x74\x3a\x20\x34\x39\x0d\x0a\x41\x63\x63\x65\x73\x73\x2d\x43\x6f\x6e\x74\x72\x6f\x6c\x2d\x41\x6c\x6c\x6f\x77\x2d\x4f\x72\x69\x67\x69\x6e\x3a\x20\x2a\x0d\x0a\x41\x63\x63\x65\x73\x73\x2d\x43\x6f\x6e\x74\x72\x6f\x6c\x2d\x41\x6c\x6c\x6f\x77\x2d\x43\x72\x65\x64\x65\x6e\x74\x69\x61\x6c\x73\x3a\x20\x74\x72\x75\x65\x0d\x0a\x41\x63\x63\x65\x73\x73\x2d\x43\x6f\x6e\x74\x72\x6f\x6c\x2d\x41\x6c\x6c\x6f\x77\x2d\x4d\x65\x74\x68\x6f\x64\x73\x3a\x20\x47\x45\x54\x0d\x0a\x58\x2d\x41\x75\x74\x68\x65\x6e\x74\x69\x63\x61\x74\x65\x64\x2d\x43\x6c\x69\x65\x6e\x74\x3a\x20\x4e\x69\x6a\x61\x74\x20\x42\x61\x6b\x68\x0d\x0a\x58\x2d\x41\x50\x49\x2d\x56\x65\x72\x73\x69\x6f\x6e\x3a\x20\x76\x31\x0d\x0a\x58\x2d\x52\x65\x73\x70\x6f\x6e\x73\x65\x2d\x43\x6f\x6e\x74\x72\x6f\x6c\x3a\x20\x6d\x69\x6e\x69\x66\x69\x65\x64\x0d\x0a\x54\x72\x61\x6e\x73\x66\x65\x72\x2d\x45\x6e\x63\x6f\x64\x69\x6e\x67\x3a\x20\x63\x68\x75\x6e\x6b\x65\x64\x0d\x0a\x43\x6f\x6e\x74\x65\x6e\x74\x2d\x54\x79\x70\x65\x3a\x20\x61\x70\x70\x6c\x69\x63\x61\x74\x69\x6f\x6e\x2f\x6a\x73\x6f\x6e\x3b\x63\x68\x61\x72\x73\x65\x74\x3d\x55\x54\x46\x2d\x38\x0d\x0a\x0d\x0a\x12\x67\xef\xbf\xbd\x34\xef\xbf\xbd\x43\x6a\x4f\xef\xbf\xbd\x62\x2e\x38\xef\xbf\xbd\xef\xbf\xbd\xef\xbf\xbd\x43\x02\x17\x01\x01\x31\x30\x62\x0d\x0a\x7b\x22\x66\x69\x78\x74\x75\x72\x65\x22\x3a\x7b\x22\x69\x64\x22\x3a\x31\x35\x38\x39\x35\x38\x2c\x22\x63\x6f\x6d\x70\x65\x74\x69\x74\x69\x6f\x6e\x49\x64\x22\x3a\x34\x34\x35\x2c\x22\x64\x61\x74\x65\x22\x3a\x22\x32\x30\x31\x38\x2d\x30\x35\x2d\x30\x34\x54\x31\x39\x3a\x30\x30\x3a\x30\x30\x5a\x22\x2c\x22\x73\x74\x61\x74\x75\x73\x22\x3a\x22\x54\x49\x4d\x45\x44\x22\x2c\x22\x6d\x61\x74\x63\x68\x64\x61\x79\x22\x3a\x33\x37\x2c\x22\x68\x6f\x6d\x65\x54\x65\x61\x6d\x4e\x61\x6d\x65\x22\x3a\x22\x42\x72\x69\x67\x68\x74\x6f\x6e\x20\x26\x20\x48\x6f\x76\x65\x20\x41\x6c\x62\x69\x6f\x6e\x22\x2c\x22\x68\x6f\x6d\x65\x54\x65\x61\x6d\x49\x64\x22\x3a\x33\x39\x37\x2c\x22\x61\x77\x61\x79\x54\x65\x61\x6d\x4e\x61\x6d\x65\x22\x3a\x22\x4d\x61\x6e\x63\x68\x65\x73\x74\x65\x72\x20\x55\x6e\x69\x74\x65\x64\x20\x46\x43\x22\x2c\x22\x61\x77\x61\x79\x54\x65\x61\x6d\x49\x64\x22\x3a\x36\x36\x2c\x22\x72\x65\x73\x75\x6c\x74\x22\x3a\x7b\x22\x67\x6f\x61\x6c\x73\x48\x6f\x6d\x65\x54\x65\x61\x6d\x22\x3a\x6e\x75\x6c\x6c\x2c\x22\x67\x6f\x61\x6c\x73\x41\x77\x61\x79\x54\x65\x61\x6d\x22\x3a\x6e\x75\x6c\x6c\x7d\x2c\x22\x6f\x64\x64\x73\x22\x3a\x6e\x75\x6c\x6c\x7d\x7d\x0d\x0a\x30\x0d\x0a\x0d\x0a\x05\xef\xbf\xbd\xef\xbf\xbd\x5e\xef\xbf\xbd\x6c\xef\xbf\xbd\xef\xbf\xbd\x6e\xef\xbf\xbd\xef\xbf\xbd\xef\xbf\xbd\x53\x18\xef\xbf\xbd\x13\x0d\x0a";

    return Betting.deployed().then(function(instance) {
      app = instance;
      return app.proposeBet(betJSON, acceptorAmount, homeScore, awayScore, {from: proposer, value: proposerAmount});
    }).then(function() {
      return app.getBets();
    }).then(function(bets) {
      return app.bets(bets[0].toNumber());
    }).then(function(bet){
      assert.equal(bet[1], proposer, "proposer is not set correctly");
      assert.equal(bet[4].toNumber(), acceptorAmount, "acceptor amount is not set correctly");
      assert.equal(bet[5].toNumber(), proposerAmount, "proposer amount is not set correctly");
      assert.equal(bet[6].toNumber(), homeScore, "home score is not set correctly");
      assert.equal(bet[7].toNumber(), awayScore, "away score is not set correctly");
      assert.equal(bet[9].toNumber(), fixtureID, "fixture ID is not set correctly");
      assert.equal(bet[10].toNumber(), totalAmount, "total amount is not set correctly");
    });
  });

  it("A user should be able to accept a bet if the value is equal to requirement", function(){
    var app;
    var acceptor = accounts[1];
    var acceptorAmount = web3.toWei(1, "ether");
    var betID;

    return Betting.deployed().then(function(instance) {
      app = instance;
    }).then(function(){
      return app.getBets();
    }).then(function(bets){
      betID = bets[0].toNumber();
      return app.acceptBet(betID, {from: acceptor, value: acceptorAmount})
    }).then(function(){
      return app.bets(betID);
    }).then(function(bet){
      assert.equal(bet[2], acceptor, "acceptor is not set correctly");
      assert.equal(bet[3], true, "accepted is set to false");
    })
  });

  it("Active bets should be resolved", function(){
    var app;
    var betID = 1000;
    var result =
    "\x20\x00\x10\x00\xff\xff\x03\x00\x23\x92\xfe\x7d\x03\x6c\x05\x00\x2c\x66\x05\x7e\x03\x6c\x05\x00\x40\x00\x00\x00\x04\x00\x00\x00\xb7\xd9\x31\xf3\x14\x0d\xcc\x40\xf7\x99\x61\x95\x1f\xb3\xff\xa3\xea\xf7\xe4\xb2\x77\xde\x17\xe7\xda\x24\x79\xda\xed\x28\xeb\xda\x69\xac\x53\xd3\xef\x4c\xd9\x20\x08\x51\xfb\x91\x5c\x44\xcb\x0a\x4a\x10\x81\x2f\x9b\x95\x3b\x0b\x4f\x62\x0e\x15\x55\x5d\xfd\xe8\x02\x95\x00\x00\x47\x45\x54\x20\x2f\x70\x72\x6f\x78\x79\x2e\x70\x79\x3f\x75\x72\x6c\x3d\x68\x74\x74\x70\x25\x33\x41\x2f\x2f\x61\x70\x69\x2e\x66\x6f\x6f\x74\x62\x61\x6c\x6c\x2d\x64\x61\x74\x61\x2e\x6f\x72\x67\x2f\x76\x31\x2f\x66\x69\x78\x74\x75\x72\x65\x73\x2f\x31\x35\x38\x39\x35\x38\x25\x33\x46\x68\x65\x61\x64\x32\x68\x65\x61\x64\x25\x33\x44\x30\x20\x48\x54\x54\x50\x2f\x31\x2e\x31\x0d\x0a\x48\x6f\x73\x74\x3a\x20\x74\x6c\x73\x70\x72\x6f\x6f\x66\x2e\x62\x61\x73\x74\x69\x65\x6e\x2e\x74\x65\x63\x68\x0d\x0a\x43\x6f\x6e\x6e\x65\x63\x74\x69\x6f\x6e\x3a\x20\x6b\x65\x65\x70\x2d\x61\x6c\x69\x76\x65\x0d\x0a\x0d\x0a\xe0\xf3\xac\x2c\x86\x85\x12\x05\x50\xaa\xf9\x17\x60\x6b\xac\xdf\x02\xda\x01\x01\x48\x54\x54\x50\x2f\x31\x2e\x31\x20\x32\x30\x30\x20\x4f\x4b\x0d\x0a\x44\x61\x74\x65\x3a\x20\x53\x61\x74\x2c\x20\x31\x32\x20\x4d\x61\x79\x20\x32\x30\x31\x38\x20\x31\x34\x3a\x35\x38\x3a\x35\x38\x20\x47\x4d\x54\x0d\x0a\x53\x65\x72\x76\x65\x72\x3a\x20\x41\x70\x61\x63\x68\x65\x2f\x32\x2e\x34\x2e\x31\x38\x20\x28\x55\x62\x75\x6e\x74\x75\x29\x0d\x0a\x43\x6f\x6e\x6e\x65\x63\x74\x69\x6f\x6e\x3a\x20\x63\x6c\x6f\x73\x65\x0d\x0a\x58\x2d\x41\x70\x70\x6c\x69\x63\x61\x74\x69\x6f\x6e\x2d\x43\x6f\x6e\x74\x65\x78\x74\x3a\x20\x61\x70\x70\x6c\x69\x63\x61\x74\x69\x6f\x6e\x3a\x70\x72\x6f\x64\x75\x63\x74\x69\x6f\x6e\x0d\x0a\x58\x2d\x52\x65\x71\x75\x65\x73\x74\x73\x2d\x41\x76\x61\x69\x6c\x61\x62\x6c\x65\x3a\x20\x34\x39\x0d\x0a\x58\x2d\x52\x65\x71\x75\x65\x73\x74\x43\x6f\x75\x6e\x74\x65\x72\x2d\x52\x65\x73\x65\x74\x3a\x20\x36\x30\x0d\x0a\x41\x63\x63\x65\x73\x73\x2d\x43\x6f\x6e\x74\x72\x6f\x6c\x2d\x41\x6c\x6c\x6f\x77\x2d\x4f\x72\x69\x67\x69\x6e\x3a\x20\x2a\x0d\x0a\x41\x63\x63\x65\x73\x73\x2d\x43\x6f\x6e\x74\x72\x6f\x6c\x2d\x41\x6c\x6c\x6f\x77\x2d\x43\x72\x65\x64\x65\x6e\x74\x69\x61\x6c\x73\x3a\x20\x74\x72\x75\x65\x0d\x0a\x41\x63\x63\x65\x73\x73\x2d\x43\x6f\x6e\x74\x72\x6f\x6c\x2d\x41\x6c\x6c\x6f\x77\x2d\x4d\x65\x74\x68\x6f\x64\x73\x3a\x20\x47\x45\x54\x0d\x0a\x58\x2d\x41\x75\x74\x68\x65\x6e\x74\x69\x63\x61\x74\x65\x64\x2d\x43\x6c\x69\x65\x6e\x74\x3a\x20\x4e\x69\x6a\x61\x74\x20\x42\x61\x6b\x68\x0d\x0a\x58\x2d\x41\x50\x49\x2d\x56\x65\x72\x73\x69\x6f\x6e\x3a\x20\x76\x31\x0d\x0a\x58\x2d\x52\x65\x73\x70\x6f\x6e\x73\x65\x2d\x43\x6f\x6e\x74\x72\x6f\x6c\x3a\x20\x6d\x69\x6e\x69\x66\x69\x65\x64\x0d\x0a\x54\x72\x61\x6e\x73\x66\x65\x72\x2d\x45\x6e\x63\x6f\x64\x69\x6e\x67\x3a\x20\x63\x68\x75\x6e\x6b\x65\x64\x0d\x0a\x43\x6f\x6e\x74\x65\x6e\x74\x2d\x54\x79\x70\x65\x3a\x20\x61\x70\x70\x6c\x69\x63\x61\x74\x69\x6f\x6e\x2f\x6a\x73\x6f\x6e\x3b\x63\x68\x61\x72\x73\x65\x74\x3d\x55\x54\x46\x2d\x38\x0d\x0a\x0d\x0a\x16\x76\x4c\x7e\x20\x4c\x64\xe6\x2a\x75\xbf\x05\x86\xe9\xb1\x58\x02\x54\x01\x01\x31\x34\x38\x0d\x0a\x7b\x22\x66\x69\x78\x74\x75\x72\x65\x22\x3a\x7b\x22\x69\x64\x22\x3a\x31\x35\x38\x39\x35\x38\x2c\x22\x63\x6f\x6d\x70\x65\x74\x69\x74\x69\x6f\x6e\x49\x64\x22\x3a\x34\x34\x35\x2c\x22\x64\x61\x74\x65\x22\x3a\x22\x32\x30\x31\x38\x2d\x30\x35\x2d\x30\x34\x54\x31\x39\x3a\x30\x30\x3a\x30\x30\x5a\x22\x2c\x22\x73\x74\x61\x74\x75\x73\x22\x3a\x22\x46\x49\x4e\x49\x53\x48\x45\x44\x22\x2c\x22\x6d\x61\x74\x63\x68\x64\x61\x79\x22\x3a\x33\x37\x2c\x22\x68\x6f\x6d\x65\x54\x65\x61\x6d\x4e\x61\x6d\x65\x22\x3a\x22\x42\x72\x69\x67\x68\x74\x6f\x6e\x20\x26\x20\x48\x6f\x76\x65\x20\x41\x6c\x62\x69\x6f\x6e\x22\x2c\x22\x68\x6f\x6d\x65\x54\x65\x61\x6d\x49\x64\x22\x3a\x33\x39\x37\x2c\x22\x61\x77\x61\x79\x54\x65\x61\x6d\x4e\x61\x6d\x65\x22\x3a\x22\x4d\x61\x6e\x63\x68\x65\x73\x74\x65\x72\x20\x55\x6e\x69\x74\x65\x64\x20\x46\x43\x22\x2c\x22\x61\x77\x61\x79\x54\x65\x61\x6d\x49\x64\x22\x3a\x36\x36\x2c\x22\x72\x65\x73\x75\x6c\x74\x22\x3a\x7b\x22\x67\x6f\x61\x6c\x73\x48\x6f\x6d\x65\x54\x65\x61\x6d\x22\x3a\x31\x2c\x22\x67\x6f\x61\x6c\x73\x41\x77\x61\x79\x54\x65\x61\x6d\x22\x3a\x30\x2c\x22\x68\x61\x6c\x66\x54\x69\x6d\x65\x22\x3a\x7b\x22\x67\x6f\x61\x6c\x73\x48\x6f\x6d\x65\x54\x65\x61\x6d\x22\x3a\x30\x2c\x22\x67\x6f\x61\x6c\x73\x41\x77\x61\x79\x54\x65\x61\x6d\x22\x3a\x30\x7d\x7d\x2c\x22\x6f\x64\x64\x73\x22\x3a\x6e\x75\x6c\x6c\x7d\x7d\x0d\x0a\x30\x0d\x0a\x0d\x0a\xab\x64\x78\x31\x2a\xd2\xb1\x00\x28\x76\xde\xc9\x5f\x4a\xc3\x38";
    var acceptor;
    var acceptorBalanceBefore;
    var acceptorBalanceAfter;
    var totalAmount;
    var winnings;

    return Betting.deployed().then(function(instance) {
      app = instance;
      return app.bets(betID);
    }).then(function(bet){
      acceptor = bet[1];
      totalAmount = bet[10].toNumber();
      console.log("totalAmount ",totalAmount);
      acceptorBalanceBefore = web3.eth.getBalance(acceptor).toNumber();
    }).then(function(){
      return app.resolveBet(betID, result);
    }).then(function(){
      return app.bets(betID);
    }).then(function(bet){
      acceptorBalanceAfter = web3.eth.getBalance(acceptor).toNumber();
      winnings = acceptorBalanceAfter - acceptorBalanceBefore;
      console.log("winnings ", winnings);
      // assert.equal(totalAmount, winnings, "payout is incorrect");
      assert.equal(bet[8], true, "resolved not set correctly");
    })
  });

});
